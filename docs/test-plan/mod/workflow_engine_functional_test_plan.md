# 工作流程引擎模組功能測試計劃

## 文件資訊
- **模組名稱**: WorkflowEngineModule (流程引擎模組)
- **文件版本**: v1.0
- **建立日期**: 2025/05/31
- **最後更新**: 2025/05/31
- **測試負責人**: QA 團隊
- **狀態**: 草稿
- **參考文件**: 
  - [`docs/mod/workflow_engine_mdd.md`](../../mod/workflow_engine_mdd.md) - 模組設計文件
  - [`docs/test-plan/overall_test_strategy.md`](../overall_test_strategy.md) - 總體測試策略
  - [`docs/user_flows/core_user_flows.md`](../../user_flows/core_user_flows.md) - 核心用戶流程
  - [`docs/mvp_definition.md`](../../mvp_definition.md) - MVP 定義

---

## 1. 引言

### 1.1 目的
本文件定義流程引擎模組的詳細功能測試計劃，確保：
- 業務流程狀態轉換正確
- 任務自動分派機制有效
- 流程追蹤和監控功能完整
- 事件觸發機制可靠
- 異常情況得到適當處理

### 1.2 範圍
本測試計劃涵蓋：
- **流程管理測試**: 流程定義、狀態機、實例管理
- **任務管理測試**: 任務分派、狀態追蹤、超時處理
- **事件處理測試**: 事件監聽、條件判斷、自動化動作
- **狀態轉換測試**: 檢驗流程各狀態間的轉換
- **整合測試**: 與其他模組的流程整合

### 1.3 測試目標
- 功能覆蓋率達到 100%（基於 MDD 功能列表）
- 狀態轉換覆蓋率達到 100%（所有可能的狀態轉換）
- 事件處理覆蓋率達到 100%（所有事件類型）
- 缺陷發現率 > 95%（在系統測試前發現）

---

## 2. 測試功能點列表

### 2.1 核心功能點
基於 [`docs/mod/workflow_engine_mdd.md`](../../mod/workflow_engine_mdd.md) 中定義的功能需求：

| 功能ID | 功能名稱 | 功能描述 | 優先級 | 測試類型 |
|--------|---------|---------|--------|---------|
| F001 | 流程定義與配置 | 定義和配置業務流程 | 高 | 功能測試 |
| F002 | 狀態機實現 | 流程狀態轉換邏輯 | 高 | 功能測試 |
| F003 | 流程實例管理 | 流程實例的創建和管理 | 高 | 功能測試 |
| F004 | 流程版本控制 | 流程配置的版本管理 | 中 | 功能測試 |
| F005 | 任務自動分派 | 根據規則自動分派任務 | 高 | 功能測試 |
| F006 | 任務狀態追蹤 | 任務執行狀態的追蹤 | 高 | 功能測試 |
| F007 | 任務超時處理 | 任務超時的檢測和處理 | 中 | 功能測試 |
| F008 | 任務重新分派 | 任務的重新分派機制 | 中 | 功能測試 |
| F009 | 事件監聽與觸發 | 系統事件的監聽和觸發 | 高 | 功能測試 |
| F010 | 條件判斷引擎 | 流程條件的判斷邏輯 | 高 | 功能測試 |
| F011 | 自動化動作執行 | 自動化動作的執行 | 中 | 功能測試 |
| F012 | 事件日誌記錄 | 流程事件的日誌記錄 | 中 | 功能測試 |

### 2.2 檢驗流程狀態測試
基於 MDD 中定義的檢驗流程狀態：

| 狀態 | 狀態描述 | 觸發條件 | 目標狀態 | 測試重點 |
|------|---------|---------|---------|---------|
| Draft | 草稿狀態 | 建立記錄 | Submitted | 初始狀態設定 |
| Submitted | 已提交 | 研究員提交 | UnderReview | 提交觸發分派 |
| UnderReview | 審核中 | 分派審核 | Approved/Rejected/OnHold | 審核流程控制 |
| Approved | 已核准 | 審核通過 | ReportGenerated | 核准觸發報告生成 |
| Rejected | 已退回 | 審核退回 | Draft | 退回重新編輯 |
| OnHold | 暫停 | 暫停審核 | UnderReview | 暫停恢復機制 |
| ReportGenerated | 報告已生成 | 生成報告 | Signed | 報告生成觸發簽核 |
| Signed | 已簽核 | 主管簽核 | Delivered | 簽核觸發發送 |
| Delivered | 已發送 | 發送客戶 | 完成 | 流程結束 |

### 2.3 用戶故事對應
基於 [`docs/user_flows/core_user_flows.md`](../../user_flows/core_user_flows.md) 中相關的用戶故事：

| 用戶故事ID | 用戶故事描述 | 相關功能點 | 測試重點 |
|-----------|-------------|-----------|---------|
| US-002 | 研究員提交檢驗報告 | F002, F005, F009 | 提交觸發流程轉換 |
| US-003 | 審核人員審核報告 | F002, F006, F010 | 審核狀態轉換 |
| US-004 | 審核人員簽核發送 | F002, F011, F012 | 簽核觸發自動化 |

---

## 3. 測試環境與配置

### 3.1 測試環境要求
參考 [`docs/environment_configs/staging_env_sot.md`](../../environment_configs/staging_env_sot.md)：

**硬體需求**:
- CPU: 2 vCPU
- Memory: 4GB RAM
- Storage: 20GB SSD

**軟體需求**:
- 作業系統: Ubuntu 20.04 LTS
- 資料庫: PostgreSQL 13+
- 消息隊列: Redis 6.0+
- 應用伺服器: Node.js 18+

### 3.2 測試配置
**環境配置**:
- 測試環境 URL: https://staging.hwayo.com
- 工作流程引擎: 獨立服務實例
- 事件總線: Redis pub/sub

**測試帳號**:
| 角色 | 帳號 | 權限範圍 | 用途 |
|------|------|---------|------|
| 研究員 | researcher_test@hwayo.com | 提交權限 | 流程發起測試 |
| 審核人員 | reviewer_test@hwayo.com | 審核權限 | 審核流程測試 |
| 主管 | supervisor_test@hwayo.com | 簽核權限 | 簽核流程測試 |
| 系統管理員 | admin_test@hwayo.com | 流程管理權限 | 流程配置測試 |

---

## 4. 測試數據準備

### 4.1 基礎測試數據
**流程實例數據**:
- 正常檢驗案例: 完整的檢驗流程實例
- 異常檢驗案例: 需要退回修改的案例
- 暫停檢驗案例: 需要暫停處理的案例

**任務分派數據**:
- 審核人員負載: 不同審核人員的任務數量
- 專業領域匹配: 審核人員專業與檢驗類型匹配
- 優先級設定: 不同優先級的檢驗案例

**事件測試數據**:
- 系統事件: 提交、審核、簽核等事件
- 定時事件: 超時檢查、提醒通知等
- 異常事件: 系統錯誤、網路中斷等

### 4.2 測試數據管理
**數據準備方式**:
- 自動生成腳本: `scripts/test-data/workflow-test-data.sql`
- 流程配置檔案: `config/workflow-definitions.json`
- 數據重置方法: 每次測試前重置流程實例狀態

---

## 5. 測試案例

### 5.1 功能測試案例

#### 5.1.1 流程狀態轉換測試

**測試案例 TC-WORKFLOW-001**
- **測試標題**: 正常檢驗流程完整轉換
- **測試目標**: 驗證檢驗流程能正確完成所有狀態轉換
- **前置條件**: 
  - 流程引擎正常運行
  - 相關用戶帳號存在
  - 流程配置正確載入
- **測試步驟**:
  1. 研究員創建檢驗記錄 (Draft)
  2. 研究員提交檢驗 (Draft → Submitted)
  3. 系統自動分派審核 (Submitted → UnderReview)
  4. 審核人員核准檢驗 (UnderReview → Approved)
  5. 系統自動生成報告 (Approved → ReportGenerated)
  6. 主管簽核報告 (ReportGenerated → Signed)
  7. 系統自動發送報告 (Signed → Delivered)
- **測試數據**: 完整的檢驗案例數據
- **預期結果**: 
  - 每個狀態轉換都正確執行
  - 狀態變更事件正確觸發
  - 相關通知正確發送
  - 流程日誌完整記錄
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 核心流程，必須通過

**測試案例 TC-WORKFLOW-002**
- **測試標題**: 審核退回流程測試
- **測試目標**: 驗證審核退回後的流程處理
- **前置條件**: 
  - 檢驗案例處於審核中狀態
  - 審核人員已登入
- **測試步驟**:
  1. 審核人員查看檢驗案例
  2. 審核人員選擇退回並填寫原因
  3. 系統更新狀態 (UnderReview → Rejected)
  4. 研究員收到退回通知
  5. 研究員修改後重新提交 (Rejected → Draft → Submitted)
  6. 系統重新分派審核
- **測試數據**: 需要退回的檢驗案例
- **預期結果**: 
  - 退回狀態正確設定
  - 退回原因正確記錄
  - 研究員收到退回通知
  - 重新提交流程正常
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 異常流程處理

**測試案例 TC-WORKFLOW-003**
- **測試標題**: 審核暫停恢復流程測試
- **測試目標**: 驗證審核暫停和恢復機制
- **前置條件**: 
  - 檢驗案例處於審核中狀態
  - 具有暫停權限的用戶已登入
- **測試步驟**:
  1. 用戶選擇暫停審核並填寫原因
  2. 系統更新狀態 (UnderReview → OnHold)
  3. 記錄暫停原因和時間
  4. 用戶選擇恢復審核
  5. 系統更新狀態 (OnHold → UnderReview)
  6. 審核流程繼續進行
- **測試數據**: 需要暫停的檢驗案例
- **預期結果**: 
  - 暫停狀態正確設定
  - 暫停原因正確記錄
  - 恢復後流程正常繼續
  - 暫停時間正確計算
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 特殊流程控制

#### 5.1.2 任務分派功能測試

**測試案例 TC-WORKFLOW-004**
- **測試標題**: 自動任務分派測試
- **測試目標**: 驗證系統能根據規則自動分派審核任務
- **前置條件**: 
  - 多個審核人員存在
  - 任務分派規則已配置
  - 檢驗案例已提交
- **測試步驟**:
  1. 提交微生物檢驗案例
  2. 系統根據專業領域分派給微生物專家
  3. 提交化學檢驗案例
  4. 系統根據負載平衡分派給負載較輕的審核人員
  5. 檢查分派結果和通知
- **測試數據**: 不同類型的檢驗案例
- **預期結果**: 
  - 任務正確分派給對應專業的審核人員
  - 負載平衡機制正常運作
  - 審核人員收到任務通知
  - 分派記錄正確保存
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 自動化分派核心功能

**測試案例 TC-WORKFLOW-005**
- **測試標題**: 任務超時處理測試
- **測試目標**: 驗證任務超時檢測和處理機制
- **前置條件**: 
  - 任務已分派給審核人員
  - 任務超時規則已配置
- **測試步驟**:
  1. 設定任務超時時間為 5 分鐘（測試用）
  2. 分派任務給審核人員
  3. 等待超時時間到達
  4. 檢查系統超時檢測
  5. 驗證超時處理動作（提醒、重新分派等）
- **測試數據**: 測試用的短超時時間配置
- **預期結果**: 
  - 超時檢測正確觸發
  - 超時通知正確發送
  - 必要時任務重新分派
  - 超時事件正確記錄
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 需要調整超時時間進行測試

#### 5.1.3 事件處理功能測試

**測試案例 TC-WORKFLOW-006**
- **測試標題**: 事件監聽與觸發測試
- **測試目標**: 驗證系統事件的監聽和觸發機制
- **前置條件**: 
  - 事件監聽器正常運行
  - 事件處理器已配置
- **測試步驟**:
  1. 觸發檢驗提交事件
  2. 檢查事件監聽器是否接收到事件
  3. 驗證事件處理器執行相應動作
  4. 觸發審核完成事件
  5. 檢查後續自動化動作執行
- **測試數據**: 各種系統事件
- **預期結果**: 
  - 事件正確監聽和接收
  - 事件處理器正確執行
  - 自動化動作按預期觸發
  - 事件處理日誌完整
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 事件驅動架構核心

### 5.2 接口測試案例

#### 5.2.1 流程管理 API 測試

**測試案例 TC-WORKFLOW-API-001**
- **測試標題**: POST /api/workflow/start 啟動流程
- **測試目標**: 驗證流程啟動 API 的功能
- **API 端點**: POST /api/workflow/start
- **請求參數**: 
  ```json
  {
    "workflowType": "inspection_process",
    "entityId": "inspection_12345",
    "initiatedBy": "researcher_test@hwayo.com",
    "data": {
      "inspectionType": "microbiology",
      "priority": "normal"
    }
  }
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "workflowInstanceId": "wf_inst_12345",
      "currentState": "draft",
      "createdAt": "2025-05-31T10:00:00Z"
    }
  }
  ```
- **狀態碼**: 201
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

**測試案例 TC-WORKFLOW-API-002**
- **測試標題**: PUT /api/workflow/transition 狀態轉換
- **測試目標**: 驗證流程狀態轉換 API 的功能
- **API 端點**: PUT /api/workflow/{instanceId}/transition
- **請求參數**: 
  ```json
  {
    "action": "submit",
    "performedBy": "researcher_test@hwayo.com",
    "comment": "檢驗數據已完成輸入",
    "data": {
      "submissionTime": "2025-05-31T10:30:00Z"
    }
  }
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "workflowInstanceId": "wf_inst_12345",
      "previousState": "draft",
      "currentState": "submitted",
      "transitionTime": "2025-05-31T10:30:00Z"
    }
  }
  ```
- **狀態碼**: 200
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

#### 5.2.2 任務管理 API 測試

**測試案例 TC-WORKFLOW-API-003**
- **測試標題**: GET /api/workflow/tasks 獲取任務列表
- **測試目標**: 驗證任務列表獲取 API 的功能
- **API 端點**: GET /api/workflow/tasks?assignee=reviewer_test@hwayo.com&status=pending
- **請求參數**: 
  ```
  assignee: reviewer_test@hwayo.com
  status: pending
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "tasks": [
        {
          "taskId": "task_12345",
          "workflowInstanceId": "wf_inst_12345",
          "taskType": "review",
          "assignee": "reviewer_test@hwayo.com",
          "status": "pending",
          "createdAt": "2025-05-31T10:30:00Z",
          "dueDate": "2025-06-02T10:30:00Z"
        }
      ],
      "total": 1
    }
  }
  ```
- **狀態碼**: 200
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

### 5.3 整合測試案例

#### 5.3.1 與數據輸入模組整合測試

**測試案例 TC-WORKFLOW-INT-001**
- **測試標題**: 數據提交觸發工作流程
- **測試目標**: 驗證數據輸入模組提交後正確觸發工作流程
- **測試場景**: 研究員完成數據輸入並提交
- **測試步驟**:
  1. 研究員登入並填寫檢驗數據
  2. 研究員提交檢驗數據
  3. 數據輸入模組觸發提交事件
  4. 工作流程引擎接收事件並啟動流程
  5. 檢查流程實例創建和狀態設定
- **預期結果**: 
  - 提交事件正確觸發
  - 工作流程實例正確創建
  - 初始狀態設定為 "submitted"
  - 自動分派審核任務
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

#### 5.3.2 與審核系統整合測試

**測試案例 TC-WORKFLOW-INT-002**
- **測試標題**: 審核結果觸發流程轉換
- **測試目標**: 驗證審核系統的審核結果能正確觸發流程轉換
- **測試場景**: 審核人員完成審核並提交結果
- **測試步驟**:
  1. 審核人員接收審核任務
  2. 審核人員完成審核並提交結果
  3. 審核系統觸發審核完成事件
  4. 工作流程引擎接收事件並更新狀態
  5. 檢查後續自動化動作執行
- **預期結果**: 
  - 審核完成事件正確觸發
  - 流程狀態正確轉換
  - 後續動作自動執行（如報告生成）
  - 相關通知正確發送
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

---

## 6. 測試執行與缺陷管理

### 6.1 測試執行計劃
**執行順序**:
1. **單元測試**: 開發團隊執行狀態機邏輯測試
2. **功能測試**: QA 團隊執行流程功能測試
3. **接口測試**: 自動化執行 API 測試
4. **事件測試**: 專門的事件處理測試
5. **整合測試**: QA + 開發團隊協作執行

**執行時程**:
| 測試階段 | 開始日期 | 結束日期 | 負責人 | 狀態 |
|---------|---------|---------|--------|------|
| 功能測試 | 待定 | 待定 | QA 團隊 | 待開始 |
| 接口測試 | 待定 | 待定 | 自動化測試 | 待開始 |
| 事件測試 | 待定 | 待定 | QA 團隊 | 待開始 |
| 整合測試 | 待定 | 待定 | QA + 開發 | 待開始 |

### 6.2 缺陷管理流程
**缺陷報告工具**: Jira
**缺陷分類標準**: 參考 [`docs/test-plan/overall_test_strategy.md`](../overall_test_strategy.md) 第 7.3 節

**缺陷優先級定義**:
- **P1 - 緊急**: 流程無法啟動、狀態轉換失敗
- **P2 - 高**: 任務分派錯誤、事件處理失敗
- **P3 - 中**: 超時處理異常、日誌記錄問題
- **P4 - 低**: 介面問題、提示訊息優化

### 6.3 測試完成標準
**功能測試完成標準**:
- 所有 P1、P2 缺陷已修復並驗證
- 功能測試案例執行率 ≥ 95%
- 功能測試案例通過率 ≥ 90%

**流程測試完成標準**:
- 所有狀態轉換路徑測試通過
- 事件處理機制穩定可靠
- 任務分派邏輯正確無誤

---

## 7. 自動化考量

### 7.1 自動化測試範圍
**適合自動化的測試**:
- 流程狀態轉換測試 (90% 自動化)
- 任務分派邏輯測試 (85% 自動化)
- 事件觸發測試 (80% 自動化)
- API 接口測試 (100% 自動化)

**不適合自動化的測試**:
- 複雜的業務邏輯驗證
- 人工審核流程測試
- 異常情況的手動處理

### 7.2 自動化工具和框架
**測試框架**: Jest + Supertest
**事件測試工具**: Redis pub/sub 測試工具
**狀態機測試**: 自定義狀態機測試框架
**CI/CD 整合**: GitHub Actions

### 7.3 自動化測試維護
**維護策略**:
- 流程配置變更時更新測試腳本
- 定期驗證事件處理邏輯
- 自動化測試結果集成到 CI/CD 流程

---

## 8. 風險與應對措施

### 8.1 測試風險識別
| 風險項目 | 風險等級 | 影響描述 | 應對措施 |
|---------|---------|---------|---------|
| 事件系統不穩定 | 高 | 影響事件驅動測試 | 準備事件模擬工具 |
| 流程配置複雜 | 中 | 測試案例設計困難 | 建立標準流程配置 |
| 狀態轉換邏輯複雜 | 中 | 測試覆蓋率難以達到 | 使用狀態轉換矩陣 |
| 並發處理問題 | 中 | 多任務同時處理異常 | 增加並發測試案例 |

### 8.2 依賴性風險
**外部依賴**:
- Redis 消息隊列: 事件處理依賴
- PostgreSQL: 流程狀態存儲依賴

**內部依賴**:
- 認證模組: 用戶權限驗證依賴
- 通知模組: 流程通知發送依賴

---

## 9. 測試報告與追蹤

### 9.1 測試進度追蹤
**追蹤指標**:
- 測試案例執行進度: 已執行/總數
- 狀態轉換覆蓋率: 已測試轉換/總轉換
- 事件處理覆蓋率: 已測試事件/總事件類型

### 9.2 測試報告格式
**日報告**: 每日工作流程測試執行狀況
**週報告**: 週度測試進度和流程問題總結
**最終報告**: 工作流程引擎測試完成總結

---

## 10. 附錄

### 10.1 測試案例執行記錄表
| 案例ID | 執行日期 | 執行人 | 結果 |