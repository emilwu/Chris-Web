# 審計日誌模組功能測試計劃

## 文件資訊
- **模組名稱**: AuditLogModule (審計與日誌模組)
- **文件版本**: v1.0
- **建立日期**: 2025/05/31
- **最後更新**: 2025/05/31
- **測試負責人**: QA 團隊
- **狀態**: 草稿
- **參考文件**: 
  - [`docs/mod/audit_log_mdd.md`](../../mod/audit_log_mdd.md) - 模組設計文件
  - [`docs/test-plan/overall_test_strategy.md`](../overall_test_strategy.md) - 總體測試策略
  - [`docs/user_flows/core_user_flows.md`](../../user_flows/core_user_flows.md) - 核心用戶流程
  - [`docs/mvp_definition.md`](../../mvp_definition.md) - MVP 定義

---

## 1. 引言

### 1.1 目的
本文件定義審計與日誌模組的詳細功能測試計劃，確保：
- 操作行為記錄完整準確
- 資料變更追蹤可靠
- 安全事件監控有效
- 日誌查詢分析功能正常
- 合規性要求得到滿足

### 1.2 範圍
本測試計劃涵蓋：
- **操作記錄測試**: 用戶操作、系統操作、API 呼叫記錄
- **資料追蹤測試**: 資料變更、版本歷史、敏感資料存取
- **安全監控測試**: 登入行為、權限變更、異常檢測
- **查詢分析測試**: 日誌搜尋、軌跡重建、統計報告
- **整合測試**: 與其他模組的日誌整合

### 1.3 測試目標
- 功能覆蓋率達到 100%（基於 MDD 功能列表）
- 日誌記錄完整性達到 100%（所有關鍵操作）
- 安全事件檢測準確性達到 99%（異常行為識別）
- 缺陷發現率 > 95%（在系統測試前發現）

---

## 2. 測試功能點列表

### 2.1 核心功能點
基於 [`docs/mod/audit_log_mdd.md`](../../mod/audit_log_mdd.md) 中定義的功能需求：

| 功能ID | 功能名稱 | 功能描述 | 優先級 | 測試類型 |
|--------|---------|---------|--------|---------|
| F001 | 用戶操作記錄 | 記錄用戶的所有操作行為 | 高 | 功能測試 |
| F002 | 系統操作記錄 | 記錄系統的自動化操作 | 高 | 功能測試 |
| F003 | API 呼叫記錄 | 記錄所有 API 的呼叫情況 | 高 | 功能測試 |
| F004 | 檔案操作記錄 | 記錄檔案的上傳下載操作 | 中 | 功能測試 |
| F005 | 資料變更記錄 | 記錄資料的變更歷史 | 高 | 功能測試 |
| F006 | 版本歷史追蹤 | 追蹤資料的版本變化 | 中 | 功能測試 |
| F007 | 敏感資料存取記錄 | 記錄敏感資料的存取 | 高 | 安全測試 |
| F008 | 資料完整性驗證 | 驗證資料的完整性 | 中 | 功能測試 |
| F009 | 登入行為記錄 | 記錄用戶登入登出行為 | 高 | 安全測試 |
| F010 | 權限變更記錄 | 記錄權限的變更操作 | 高 | 安全測試 |
| F011 | 異常行為檢測 | 檢測和記錄異常行為 | 高 | 安全測試 |
| F012 | 安全事件告警 | 安全事件的告警機制 | 中 | 安全測試 |
| F013 | 日誌搜尋查詢 | 日誌的搜尋和查詢功能 | 中 | 功能測試 |
| F014 | 操作軌跡重建 | 重建用戶的操作軌跡 | 中 | 功能測試 |
| F015 | 統計分析報告 | 生成統計分析報告 | 低 | 功能測試 |
| F016 | 合規性報告生成 | 生成合規性報告 | 中 | 功能測試 |

### 2.2 日誌類型測試
基於不同類型的審計日誌：

| 日誌類型 | 記錄內容 | 觸發條件 | 測試重點 |
|---------|---------|---------|---------|
| 用戶操作日誌 | 登入、數據輸入、審核操作 | 用戶執行操作 | 完整性、準確性 |
| 系統操作日誌 | 自動分派、報告生成、通知發送 | 系統自動執行 | 時序性、關聯性 |
| 安全事件日誌 | 登入失敗、權限異常、異常存取 | 安全相關事件 | 及時性、敏感性 |
| 資料變更日誌 | 數據修改、刪除、狀態變更 | 資料異動 | 變更前後對比 |
| API 呼叫日誌 | 請求參數、回應結果、執行時間 | API 被呼叫 | 效能、錯誤追蹤 |

### 2.3 合規性要求測試
基於法規和合規性要求：

| 合規要求 | 相關功能點 | 測試標準 | 驗證重點 |
|---------|-----------|---------|---------|
| 資料保護法 | F007, F009 | 敏感資料存取記錄 | 存取控制、記錄完整 |
| 稽核要求 | F001, F005, F014 | 操作可追溯性 | 軌跡完整、時間準確 |
| 安全標準 | F009, F010, F011 | 安全事件監控 | 檢測準確、回應及時 |
| 業務合規 | F016 | 合規報告生成 | 報告準確、格式標準 |

---

## 3. 測試環境與配置

### 3.1 測試環境要求
參考 [`docs/environment_configs/staging_env_sot.md`](../../environment_configs/staging_env_sot.md)：

**硬體需求**:
- CPU: 2 vCPU
- Memory: 4GB RAM
- Storage: 100GB SSD (大量日誌存儲需求)

**軟體需求**:
- 作業系統: Ubuntu 20.04 LTS
- 資料庫: PostgreSQL 13+ (日誌存儲)
- 搜尋引擎: Elasticsearch 7.0+ (日誌搜尋)
- 應用伺服器: Node.js 18+

### 3.2 測試配置
**環境配置**:
- 測試環境 URL: https://staging.hwayo.com
- 日誌存儲: PostgreSQL + Elasticsearch
- 日誌保留期: 測試期間設為 30 天

**測試帳號**:
| 角色 | 帳號 | 權限範圍 | 用途 |
|------|------|---------|------|
| 系統管理員 | admin_test@hwayo.com | 日誌查看權限 | 日誌管理測試 |
| 稽核人員 | auditor_test@hwayo.com | 稽核查詢權限 | 稽核功能測試 |
| 一般用戶 | user_test@hwayo.com | 基本操作權限 | 操作記錄測試 |
| 測試用戶 | test_user@hwayo.com | 限制權限 | 權限測試 |

---

## 4. 測試數據準備

### 4.1 基礎測試數據
**操作記錄數據**:
- 正常操作: 登入、數據輸入、審核、下載等
- 異常操作: 多次登入失敗、權限越權嘗試
- 系統操作: 自動分派、報告生成、通知發送

**資料變更數據**:
- 數據修改: 檢驗數據的修改記錄
- 狀態變更: 工作流程狀態的變更
- 配置變更: 系統配置的修改

**安全事件數據**:
- 登入事件: 成功、失敗、異常登入
- 權限事件: 權限變更、越權嘗試
- 異常事件: 異常 IP、異常時間存取

### 4.2 測試數據管理
**數據準備方式**:
- 自動生成腳本: `scripts/test-data/audit-log-test-data.sql`
- 模擬操作腳本: `scripts/simulate-operations.js`
- 數據清理方法: 測試完成後清理測試日誌

---

## 5. 測試案例

### 5.1 功能測試案例

#### 5.1.1 用戶操作記錄測試

**測試案例 TC-AUDIT-001**
- **測試標題**: 用戶登入操作記錄測試
- **測試目標**: 驗證用戶登入操作能正確記錄到審計日誌
- **前置條件**: 
  - 審計日誌模組正常運行
  - 測試用戶帳號存在
- **測試步驟**:
  1. 用戶執行登入操作
  2. 檢查審計日誌是否記錄登入事件
  3. 驗證日誌內容的完整性
  4. 檢查時間戳的準確性
  5. 確認用戶資訊的正確性
- **測試數據**: 測試用戶登入憑證
- **預期結果**: 
  - 登入事件正確記錄
  - 日誌包含用戶 ID、IP 地址、時間戳
  - 登入結果（成功/失敗）正確記錄
  - 會話 ID 正確關聯
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 基礎安全審計功能

**測試案例 TC-AUDIT-002**
- **測試標題**: 數據輸入操作記錄測試
- **測試目標**: 驗證數據輸入操作的完整記錄
- **前置條件**: 
  - 用戶已成功登入
  - 數據輸入功能可用
- **測試步驟**:
  1. 用戶填寫並提交檢驗數據
  2. 檢查操作記錄的生成
  3. 驗證記錄的詳細資訊
  4. 檢查資料變更的追蹤
  5. 確認操作結果的記錄
- **測試數據**: 完整的檢驗數據表單
- **預期結果**: 
  - 數據輸入操作正確記錄
  - 包含操作類型、資源、詳細內容
  - 資料變更前後狀態記錄
  - 操作時間和用戶資訊準確
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 業務操作審計

#### 5.1.2 系統操作記錄測試

**測試案例 TC-AUDIT-003**
- **測試標題**: 自動任務分派記錄測試
- **測試目標**: 驗證系統自動操作的記錄功能
- **前置條件**: 
  - 工作流程引擎正常運行
  - 自動分派規則已配置
- **測試步驟**:
  1. 觸發自動任務分派流程
  2. 檢查系統操作記錄
  3. 驗證分派邏輯的記錄
  4. 檢查分派結果的記錄
  5. 確認時序關係的正確性
- **測試數據**: 觸發自動分派的檢驗案例
- **預期結果**: 
  - 自動分派操作正確記錄
  - 包含分派規則、目標用戶
  - 分派時間和結果準確
  - 與相關操作的關聯正確
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 系統自動化審計

#### 5.1.3 API 呼叫記錄測試

**測試案例 TC-AUDIT-004**
- **測試標題**: API 呼叫記錄測試
- **測試目標**: 驗證 API 呼叫的完整記錄
- **前置條件**: 
  - API 服務正常運行
  - API 記錄功能已啟用
- **測試步驟**:
  1. 執行各種 API 呼叫操作
  2. 檢查 API 呼叫記錄
  3. 驗證請求參數記錄
  4. 檢查回應結果記錄
  5. 確認執行時間記錄
- **測試數據**: 不同類型的 API 請求
- **預期結果**: 
  - API 呼叫完整記錄
  - 包含端點、方法、參數
  - 回應狀態碼和內容記錄
  - 執行時間和效能指標
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: API 使用審計

#### 5.1.4 資料變更追蹤測試

**測試案例 TC-AUDIT-005**
- **測試標題**: 資料變更追蹤測試
- **測試目標**: 驗證資料變更的完整追蹤
- **前置條件**: 
  - 資料變更追蹤功能已啟用
  - 存在可修改的資料
- **測試步驟**:
  1. 修改檢驗數據內容
  2. 檢查變更記錄的生成
  3. 驗證變更前後的對比
  4. 檢查變更原因的記錄
  5. 確認變更者資訊的記錄
- **測試數據**: 可修改的檢驗數據
- **預期結果**: 
  - 資料變更完整追蹤
  - 變更前後值正確記錄
  - 變更時間和操作者準確
  - 變更原因清楚記錄
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 資料完整性審計

#### 5.1.5 安全事件監控測試

**測試案例 TC-AUDIT-006**
- **測試標題**: 登入失敗監控測試
- **測試目標**: 驗證登入失敗事件的監控和記錄
- **前置條件**: 
  - 安全監控功能已啟用
  - 登入失敗檢測規則已配置
- **測試步驟**:
  1. 故意使用錯誤密碼登入
  2. 連續多次登入失敗
  3. 檢查安全事件記錄
  4. 驗證異常檢測觸發
  5. 確認告警機制啟動
- **測試數據**: 錯誤的登入憑證
- **預期結果**: 
  - 登入失敗事件正確記錄
  - 連續失敗觸發異常檢測
  - 安全告警及時生成
  - 相關安全措施啟動
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 安全監控關鍵功能

**測試案例 TC-AUDIT-007**
- **測試標題**: 權限異常檢測測試
- **測試目標**: 驗證權限異常行為的檢測
- **前置條件**: 
  - 權限控制系統正常
  - 異常檢測規則已配置
- **測試步驟**:
  1. 嘗試存取超出權限的資源
  2. 檢查權限異常記錄
  3. 驗證異常行為檢測
  4. 檢查安全事件分類
  5. 確認後續處理措施
- **測試數據**: 權限受限的測試帳號
- **預期結果**: 
  - 權限異常正確檢測
  - 異常行為詳細記錄
  - 安全事件正確分類
  - 防護措施及時啟動
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 權限安全監控

#### 5.1.6 日誌查詢分析測試

**測試案例 TC-AUDIT-008**
- **測試標題**: 日誌搜尋查詢測試
- **測試目標**: 驗證日誌搜尋和查詢功能
- **前置條件**: 
  - 存在足夠的歷史日誌數據
  - 搜尋功能已實現
- **測試步驟**:
  1. 使用不同條件搜尋日誌
  2. 測試時間範圍篩選
  3. 測試用戶和操作類型篩選
  4. 驗證搜尋結果準確性
  5. 測試搜尋效能
- **測試數據**: 多樣化的歷史日誌記錄
- **預期結果**: 
  - 搜尋功能響應迅速
  - 搜尋結果準確相關
  - 篩選條件正確應用
  - 支援複雜查詢條件
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 日誌分析工具

**測試案例 TC-AUDIT-009**
- **測試標題**: 操作軌跡重建測試
- **測試目標**: 驗證用戶操作軌跡的重建功能
- **前置條件**: 
  - 用戶有完整的操作歷史
  - 軌跡重建功能已實現
- **測試步驟**:
  1. 選擇特定用戶和時間範圍
  2. 執行操作軌跡重建
  3. 檢查軌跡的完整性
  4. 驗證操作順序的正確性
  5. 確認時間線的準確性
- **測試數據**: 特定用戶的操作歷史
- **預期結果**: 
  - 操作軌跡完整重建
  - 操作順序邏輯正確
  - 時間線準確無誤
  - 關聯操作正確識別
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 稽核分析功能

### 5.2 接口測試案例

#### 5.2.1 日誌記錄 API 測試

**測試案例 TC-AUDIT-API-001**
- **測試標題**: POST /api/audit/log 日誌記錄
- **測試目標**: 驗證日誌記錄 API 的功能
- **API 端點**: POST /api/audit/log
- **請求參數**: 
  ```json
  {
    "eventType": "user_operation",
    "category": "data_input",
    "userId": "user_12345",
    "sessionId": "session_12345",
    "resource": "inspection_data",
    "action": "create",
    "details": {
      "inspectionId": "inspection_12345",
      "dataFields": ["temperature", "humidity"],
      "previousValues": null,
      "newValues": {"temperature": 25.5, "humidity": 60}
    }
  }
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "logId": "log_12345",
      "timestamp": "2025-05-31T10:00:00Z",
      "recorded": true
    }
  }
  ```
- **狀態碼**: 201
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

**測試案例 TC-AUDIT-API-002**
- **測試標題**: GET /api/audit/logs 日誌查詢
- **測試目標**: 驗證日誌查詢 API 的功能
- **API 端點**: GET /api/audit/logs?userId=user_12345&startDate=2025-05-01&endDate=2025-05-31&category=data_input
- **請求參數**: 
  ```
  userId: user_12345
  startDate: 2025-05-01
  endDate: 2025-05-31
  category: data_input
  page: 1
  limit: 50
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "logs": [
        {
          "id": "log_12345",
          "timestamp": "2025-05-31T10:00:00Z",
          "eventType": "user_operation",
          "category": "data_input",
          "userId": "user_12345",
          "resource": "inspection_data",
          "action": "create",
          "summary": "Created new inspection data"
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 50,
        "total": 125,
        "totalPages": 3
      }
    }
  }
  ```
- **狀態碼**: 200
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

#### 5.2.2 統計報告 API 測試

**測試案例 TC-AUDIT-API-003**
- **測試標題**: GET /api/audit/reports/statistics 統計報告
- **測試目標**: 驗證審計統計報告 API
- **API 端點**: GET /api/audit/reports/statistics?period=monthly&year=2025&month=5
- **請求參數**: 
  ```
  period: monthly
  year: 2025
  month: 5
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "period": "2025-05",
      "statistics": {
        "totalOperations": 1250,
        "userOperations": 980,
        "systemOperations": 270,
        "securityEvents": 15,
        "dataChanges": 450,
        "topUsers": [
          {"userId": "user_001", "operations": 125},
          {"userId": "user_002", "operations": 98}
        ],
        "operationsByCategory": {
          "data_input": 450,
          "review": 320,
          "report_generation": 180,
          "user_management": 50
        }
      }
    }
  }
  ```
- **狀態碼**: 200
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

### 5.3 整合測試案例

#### 5.3.1 與認證模組整合測試

**測試案例 TC-AUDIT-INT-001**
- **測試標題**: 認證事件審計記錄
- **測試目標**: 驗證認證模組的事件能正確記錄到審計日誌
- **測試場景**: 用戶登入登出過程的完整審計
- **測試步驟**:
  1. 用戶執行登入操作
  2. 認證模組觸發登入事件
  3. 審計模組記錄登入日誌
  4. 用戶執行登出操作
  5. 審計模組記錄登出日誌
- **預期結果**: 
  - 登入事件正確記錄
  - 登出事件正確記錄
  - 會話資訊完整關聯
  - 時間序列邏輯正確
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

#### 5.3.2 與工作流程引擎整合測試

**測試案例 TC-AUDIT-INT-002**
- **測試標題**: 工作流程狀態變更審計
- **測試目標**: 驗證工作流程狀態變更的審計記錄
- **測試場景**: 檢驗流程狀態變更的完整追蹤
- **測試步驟**:
  1. 檢驗案例狀態發生變更
  2. 工作流程引擎觸發狀態變更事件
  3. 審計模組記錄狀態變更
  4. 檢查變更前後狀態記錄
  5. 驗證變更原因和操作者
- **預期結果**: 
  - 狀態變更完整記錄
  - 變更前後狀態準確
  - 觸發原因清楚記錄
  - 相關操作者正確識別
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

---

## 6. 測試執行與缺陷管理

### 6.1 測試執行計劃
**執行順序**:
1. **單元測試**: 開發團隊執行日誌記錄邏輯測試
2. **功能測試**: QA 團隊執行審計功能測試
3. **接口測試**: 自動化執行 API 測試
4. **安全測試**: 專門的安全審計測試
5. **整合測試**: QA + 開發團隊協作執行

**執行時程**:
| 測試階段 | 開始日期 | 結束日期 | 負責人 | 狀態 |
|---------|---------|---------|--------|------|
| 功能測試 | 待定 | 待定 | QA 團隊 | 待開始 |
| 接口測試 | 待定 | 待定 | 自動化測試 | 待開始 |
| 安全測試 | 待定 | 待定 | 安全團隊 | 待開始 |
| 整合測試 | 待定 | 待定 | QA + 開發 | 待開始 |

### 6.2 缺陷管理流程
**缺陷報告工具**: Jira
**缺陷分類標準**: 參考 [`docs/test-plan/overall_test_strategy.md`](../overall_test_strategy.md) 第 7.3 節

**缺陷優先級定義**:
- **P1 - 緊急**: 日誌記錄失敗、安全事件