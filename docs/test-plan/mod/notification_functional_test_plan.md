# 通知模組功能測試計劃

## 文件資訊
- **模組名稱**: NotificationModule (通知與提醒模組)
- **文件版本**: v1.0
- **建立日期**: 2025/05/31
- **最後更新**: 2025/05/31
- **測試負責人**: QA 團隊
- **狀態**: 草稿
- **參考文件**: 
  - [`docs/mod/notification_mdd.md`](../../mod/notification_mdd.md) - 模組設計文件
  - [`docs/test-plan/overall_test_strategy.md`](../overall_test_strategy.md) - 總體測試策略
  - [`docs/user_flows/core_user_flows.md`](../../user_flows/core_user_flows.md) - 核心用戶流程
  - [`docs/mvp_definition.md`](../../mvp_definition.md) - MVP 定義

---

## 1. 引言

### 1.1 目的
本文件定義通知與提醒模組的詳細功能測試計劃，確保：
- 通知發送功能穩定可靠
- 模板管理系統正確運作
- 排程提醒功能準確執行
- 用戶偏好設定有效
- 通知歷史追蹤完整

### 1.2 範圍
本測試計劃涵蓋：
- **通知發送測試**: Email 通知、系統內通知、批量發送
- **模板管理測試**: 模板設計、變數管理、預覽測試
- **排程功能測試**: 定時通知、週期提醒、條件觸發
- **偏好設定測試**: 用戶偏好、頻率控制、通道選擇
- **整合測試**: 與其他模組的通知整合

### 1.3 測試目標
- 功能覆蓋率達到 100%（基於 MDD 功能列表）
- 通知發送成功率達到 99%（各種通知類型）
- 排程準確性達到 100%（定時和週期性通知）
- 缺陷發現率 > 95%（在系統測試前發現）

---

## 2. 測試功能點列表

### 2.1 核心功能點
基於 [`docs/mod/notification_mdd.md`](../../mod/notification_mdd.md) 中定義的功能需求：

| 功能ID | 功能名稱 | 功能描述 | 優先級 | 測試類型 |
|--------|---------|---------|--------|---------|
| F001 | Email 通知發送 | Email 通知的發送功能 | 高 | 功能測試 |
| F002 | 系統內通知 | 系統內部通知功能 | 高 | 功能測試 |
| F003 | 批量通知發送 | 批量通知的發送功能 | 中 | 效能測試 |
| F004 | 通知狀態追蹤 | 通知發送狀態的追蹤 | 高 | 功能測試 |
| F005 | 通知模板設計 | 通知模板的設計功能 | 中 | 功能測試 |
| F006 | 模板變數管理 | 模板變數的管理功能 | 中 | 功能測試 |
| F007 | 多語系模板支援 | 多語系模板的支援 | 低 | 功能測試 |
| F008 | 模板預覽測試 | 模板預覽和測試功能 | 中 | 功能測試 |
| F009 | 定時通知發送 | 定時通知的發送功能 | 高 | 功能測試 |
| F010 | 週期性提醒 | 週期性提醒功能 | 中 | 功能測試 |
| F011 | 條件觸發通知 | 條件觸發的通知功能 | 高 | 功能測試 |
| F012 | 提醒規則管理 | 提醒規則的管理功能 | 中 | 功能測試 |
| F013 | 用戶通知偏好 | 用戶通知偏好設定 | 中 | 功能測試 |
| F014 | 通知頻率控制 | 通知頻率的控制功能 | 中 | 功能測試 |
| F015 | 通知通道選擇 | 通知通道的選擇功能 | 中 | 功能測試 |
| F016 | 免打擾時間設定 | 免打擾時間的設定功能 | 低 | 功能測試 |

### 2.2 通知類型測試
基於業務流程的不同通知類型：

| 通知類型 | 觸發條件 | 接收者 | 測試重點 |
|---------|---------|--------|---------|
| 任務分派通知 | 審核任務分派 | 審核人員 | 及時性、準確性 |
| 提交確認通知 | 檢驗數據提交 | 研究員 | 內容完整性 |
| 審核完成通知 | 審核結果提交 | 研究員、主管 | 狀態更新準確性 |
| 報告完成通知 | 報告生成完成 | 客戶 | 下載連結有效性 |
| 超時提醒通知 | 任務超時 | 相關人員 | 提醒時機準確性 |
| 系統維護通知 | 系統維護 | 所有用戶 | 廣播功能 |

### 2.3 用戶故事對應
基於 [`docs/user_flows/core_user_flows.md`](../../user_flows/core_user_flows.md) 中相關的用戶故事：

| 用戶故事ID | 用戶故事描述 | 相關功能點 | 測試重點 |
|-----------|-------------|-----------|---------|
| US-002 | 研究員提交檢驗報告 | F001, F002, F011 | 提交確認通知 |
| US-003 | 審核人員審核報告 | F001, F009, F011 | 任務分派和提醒 |
| US-005 | 客戶報告接收 | F001, F004 | 報告完成通知 |

---

## 3. 測試環境與配置

### 3.1 測試環境要求
參考 [`docs/environment_configs/staging_env_sot.md`](../../environment_configs/staging_env_sot.md)：

**硬體需求**:
- CPU: 2 vCPU
- Memory: 4GB RAM
- Storage: 20GB SSD

**軟體需求**:
- 作業系統: Ubuntu 20.04 LTS
- Email 服務: SMTP 服務器或 SendGrid
- 消息隊列: Redis 6.0+
- 應用伺服器: Node.js 18+

### 3.2 測試配置
**環境配置**:
- 測試環境 URL: https://staging.hwayo.com
- Email 服務: 測試用 SMTP 配置
- 通知隊列: Redis 測試實例

**測試帳號**:
| 角色 | 帳號 | Email | 用途 |
|------|------|-------|------|
| 研究員 | researcher_test@hwayo.com | researcher_test@example.com | 接收通知測試 |
| 審核人員 | reviewer_test@hwayo.com | reviewer_test@example.com | 任務通知測試 |
| 客戶 | customer_test@hwayo.com | customer_test@example.com | 報告通知測試 |
| 管理員 | admin_test@hwayo.com | admin_test@example.com | 系統通知測試 |

---

## 4. 測試數據準備

### 4.1 基礎測試數據
**通知模板數據**:
- 任務分派模板: 審核任務分派通知模板
- 提交確認模板: 檢驗數據提交確認模板
- 報告完成模板: 報告生成完成通知模板
- 提醒模板: 各種提醒通知模板

**用戶偏好數據**:
- 通知頻率設定: 即時、每日摘要、每週摘要
- 通道偏好: Email、系統內通知
- 免打擾時間: 晚上 10 點到早上 8 點

**排程測試數據**:
- 定時通知: 特定時間點的通知
- 週期性提醒: 每日、每週、每月提醒
- 條件觸發: 基於狀態變更的通知

### 4.2 測試數據管理
**數據準備方式**:
- 自動生成腳本: `scripts/test-data/notification-test-data.sql`
- 模板檔案: `templates/notification/` 目錄下的模板檔案
- 數據重置方法: 每次測試前清理通知歷史

---

## 5. 測試案例

### 5.1 功能測試案例

#### 5.1.1 Email 通知發送測試

**測試案例 TC-NOTIFICATION-001**
- **測試標題**: Email 通知發送功能測試
- **測試目標**: 驗證系統能正確發送 Email 通知
- **前置條件**: 
  - Email 服務配置正確
  - 收件人 Email 地址有效
  - 通知模板已準備
- **測試步驟**:
  1. 觸發檢驗數據提交事件
  2. 系統生成提交確認通知
  3. 檢查 Email 發送狀態
  4. 驗證 Email 內容和格式
  5. 確認收件人收到 Email
- **測試數據**: 研究員提交檢驗數據
- **預期結果**: 
  - Email 成功發送
  - 內容格式正確
  - 收件人及時收到
  - 發送狀態正確記錄
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 核心通知功能

**測試案例 TC-NOTIFICATION-002**
- **測試標題**: Email 發送失敗處理測試
- **測試目標**: 驗證 Email 發送失敗時的錯誤處理
- **前置條件**: 
  - 配置無效的 Email 地址
  - 或暫時關閉 Email 服務
- **測試步驟**:
  1. 觸發通知發送到無效 Email
  2. 檢查系統錯誤處理
  3. 驗證重試機制
  4. 檢查錯誤日誌記錄
  5. 確認失敗狀態更新
- **測試數據**: 無效 Email 地址
- **預期結果**: 
  - 發送失敗被正確檢測
  - 重試機制正常運作
  - 錯誤原因正確記錄
  - 最終狀態標記為失敗
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 錯誤處理機制

#### 5.1.2 系統內通知測試

**測試案例 TC-NOTIFICATION-003**
- **測試標題**: 系統內通知功能測試
- **測試目標**: 驗證系統內通知的顯示和管理功能
- **前置條件**: 
  - 用戶已登入系統
  - 通知功能已啟用
- **測試步驟**:
  1. 觸發系統內通知事件
  2. 檢查通知在界面上的顯示
  3. 測試通知的標記已讀功能
  4. 驗證通知的刪除功能
  5. 檢查通知歷史記錄
- **測試數據**: 審核任務分派通知
- **預期結果**: 
  - 通知正確顯示在界面上
  - 未讀通知有明顯標示
  - 標記已讀功能正常
  - 通知歷史完整保存
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 用戶體驗重要功能

#### 5.1.3 批量通知發送測試

**測試案例 TC-NOTIFICATION-004**
- **測試標題**: 批量通知發送效能測試
- **測試目標**: 驗證系統能穩定處理批量通知發送
- **前置條件**: 
  - 準備 100 個測試用戶
  - 通知服務正常運行
- **測試步驟**:
  1. 觸發系統維護通知（發送給所有用戶）
  2. 監控批量發送進度
  3. 檢查發送成功率
  4. 驗證發送時間
  5. 確認所有用戶都收到通知
- **測試數據**: 100 個測試用戶帳號
- **預期結果**: 
  - 所有通知成功發送
  - 發送時間在可接受範圍內（< 5 分鐘）
  - 系統穩定無錯誤
  - 發送狀態正確記錄
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 效能和穩定性測試

#### 5.1.4 模板管理功能測試

**測試案例 TC-NOTIFICATION-005**
- **測試標題**: 通知模板管理測試
- **測試目標**: 驗證通知模板的創建、編輯和管理功能
- **前置條件**: 
  - 具有模板管理權限
  - 模板編輯器正常運行
- **測試步驟**:
  1. 創建新的通知模板
  2. 設定模板變數和內容
  3. 預覽模板效果
  4. 測試模板變數替換
  5. 儲存並啟用模板
- **測試數據**: 新的審核完成通知模板
- **預期結果**: 
  - 模板成功創建和保存
  - 變數替換功能正常
  - 預覽效果正確
  - 模板版本控制正常
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 模板系統核心功能

#### 5.1.5 排程通知功能測試

**測試案例 TC-NOTIFICATION-006**
- **測試標題**: 定時通知發送測試
- **測試目標**: 驗證定時通知的準確發送
- **前置條件**: 
  - 排程服務正常運行
  - 系統時間準確
- **測試步驟**:
  1. 設定 5 分鐘後發送的定時通知
  2. 等待指定時間
  3. 檢查通知是否按時發送
  4. 驗證發送時間的準確性
  5. 確認通知內容正確
- **測試數據**: 測試用定時通知
- **預期結果**: 
  - 通知在指定時間準確發送
  - 時間誤差在可接受範圍內（< 1 分鐘）
  - 通知內容完整正確
  - 排程狀態正確更新
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 需要等待時間進行測試

**測試案例 TC-NOTIFICATION-007**
- **測試標題**: 週期性提醒測試
- **測試目標**: 驗證週期性提醒的正確執行
- **前置條件**: 
  - 週期性提醒規則已配置
  - 測試時間週期較短（如每 2 分鐘）
- **測試步驟**:
  1. 配置每 2 分鐘的週期性提醒
  2. 觀察前 3 次提醒的發送
  3. 檢查提醒間隔的準確性
  4. 驗證提醒內容的一致性
  5. 測試提醒的停止功能
- **測試數據**: 測試用週期性提醒配置
- **預期結果**: 
  - 提醒按週期準確發送
  - 間隔時間準確
  - 內容保持一致
  - 停止功能正常
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 需要較長時間觀察

#### 5.1.6 用戶偏好設定測試

**測試案例 TC-NOTIFICATION-008**
- **測試標題**: 用戶通知偏好設定測試
- **測試目標**: 驗證用戶通知偏好設定的有效性
- **前置條件**: 
  - 用戶已登入系統
  - 偏好設定功能可用
- **測試步驟**:
  1. 用戶設定只接收 Email 通知
  2. 觸發通知事件
  3. 檢查是否只發送 Email
  4. 用戶改為只接收系統內通知
  5. 再次觸發事件並檢查結果
- **測試數據**: 不同的通知偏好設定
- **預期結果**: 
  - 偏好設定正確保存
  - 通知按偏好發送
  - 設定變更立即生效
  - 不符合偏好的通知被過濾
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]
- **備註**: 個性化功能

### 5.2 接口測試案例

#### 5.2.1 通知發送 API 測試

**測試案例 TC-NOTIFICATION-API-001**
- **測試標題**: POST /api/notifications/send 發送通知
- **測試目標**: 驗證通知發送 API 的功能
- **API 端點**: POST /api/notifications/send
- **請求參數**: 
  ```json
  {
    "type": "task_assignment",
    "channel": "email",
    "recipientId": "reviewer_test@hwayo.com",
    "templateId": "task_assignment_template",
    "templateData": {
      "taskId": "task_12345",
      "inspectionType": "microbiology",
      "dueDate": "2025-06-02"
    },
    "priority": "normal"
  }
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "notificationId": "notif_12345",
      "status": "queued",
      "estimatedDelivery": "2025-05-31T10:05:00Z",
      "createdAt": "2025-05-31T10:00:00Z"
    }
  }
  ```
- **狀態碼**: 201
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

**測試案例 TC-NOTIFICATION-API-002**
- **測試標題**: GET /api/notifications/status 通知狀態查詢
- **測試目標**: 驗證通知狀態查詢 API
- **API 端點**: GET /api/notifications/{notificationId}/status
- **請求參數**: 
  ```
  notificationId: notif_12345
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "notificationId": "notif_12345",
      "status": "delivered",
      "deliveredAt": "2025-05-31T10:02:00Z",
      "attempts": 1,
      "lastAttemptAt": "2025-05-31T10:02:00Z"
    }
  }
  ```
- **狀態碼**: 200
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

#### 5.2.2 用戶偏好 API 測試

**測試案例 TC-NOTIFICATION-API-003**
- **測試標題**: PUT /api/users/preferences 更新通知偏好
- **測試目標**: 驗證用戶通知偏好更新 API
- **API 端點**: PUT /api/users/{userId}/preferences
- **請求參數**: 
  ```json
  {
    "emailNotifications": true,
    "inAppNotifications": false,
    "notificationFrequency": "immediate",
    "quietHours": {
      "start": "22:00",
      "end": "08:00"
    }
  }
  ```
- **預期回應**: 
  ```json
  {
    "status": "success",
    "data": {
      "userId": "user_12345",
      "preferences": {
        "emailNotifications": true,
        "inAppNotifications": false,
        "notificationFrequency": "immediate",
        "quietHours": {
          "start": "22:00",
          "end": "08:00"
        }
      },
      "updatedAt": "2025-05-31T10:00:00Z"
    }
  }
  ```
- **狀態碼**: 200
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

### 5.3 整合測試案例

#### 5.3.1 與工作流程引擎整合測試

**測試案例 TC-NOTIFICATION-INT-001**
- **測試標題**: 工作流程事件觸發通知
- **測試目標**: 驗證工作流程狀態變更能正確觸發通知
- **測試場景**: 檢驗提交後觸發審核任務分派通知
- **測試步驟**:
  1. 研究員提交檢驗數據
  2. 工作流程引擎觸發狀態變更事件
  3. 通知模組接收事件並發送通知
  4. 審核人員收到任務分派通知
  5. 驗證通知內容和時機
- **預期結果**: 
  - 狀態變更事件正確觸發通知
  - 通知內容包含正確的任務資訊
  - 審核人員及時收到通知
  - 通知狀態正確記錄
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

#### 5.3.2 與報告產生器整合測試

**測試案例 TC-NOTIFICATION-INT-002**
- **測試標題**: 報告完成觸發客戶通知
- **測試目標**: 驗證報告生成完成後能正確通知客戶
- **測試場景**: 報告生成完成後通知客戶下載
- **測試步驟**:
  1. 報告產生器完成報告生成
  2. 觸發報告完成事件
  3. 通知模組發送客戶通知
  4. 客戶收到報告完成通知
  5. 驗證下載連結有效性
- **預期結果**: 
  - 報告完成事件正確觸發通知
  - 客戶及時收到通知
  - 通知包含有效的下載連結
  - 通知內容專業完整
- **實際結果**: [執行時填寫]
- **測試狀態**: [Pass/Fail/Blocked/Skip]

---

## 6. 測試執行與缺陷管理

### 6.1 測試執行計劃
**執行順序**:
1. **單元測試**: 開發團隊執行通知邏輯測試
2. **功能測試**: QA 團隊執行通知功能測試
3. **接口測試**: 自動化執行 API 測試
4. **效能測試**: 專門的批量通知測試
5. **整合測試**: QA + 開發團隊協作執行

**執行時程**:
| 測試階段 | 開始日期 | 結束日期 | 負責人 | 狀態 |
|---------|---------|---------|--------|------|
| 功能測試 | 待定 | 待定 | QA 團隊 | 待開始 |
| 接口測試 | 待定 | 待定 | 自動化測試 | 待開始 |
| 效能測試 | 待定 | 待定 | QA 團隊 | 待開始 |
| 整合測試 | 待定 | 待定 | QA + 開發 | 待開始 |

### 6.2 缺陷管理流程
**缺陷報告工具**: Jira
**缺陷分類標準**: 參考 [`docs/test-plan/overall_test_strategy.md`](../overall_test_strategy.md) 第 7.3 節

**缺陷優先級定義**:
- **P1 - 緊急**: 通知無法發送、系統崩潰
- **P2 - 高**: 通知延遲、內容錯誤
- **P3 - 中**: 偏好設定無效、界面問題
- **P4 - 低**: 介面美化、提示訊息優化

### 6.3 測試完成標準
**功能測試完成標準**:
- 所有 P1、P2 缺陷已修復並驗證
- 功能測試案例執行率 ≥ 95%
- 功能測試案例通過率 ≥ 90%

**通知可靠性標準**:
- Email 發送成功率 ≥ 99%
- 系統內通知顯示正確率 100%
- 排程通知準確性 ≥ 99%

---

## 7. 自動化考量

### 7.1 自動化測試範圍
**適合自動化的測試**:
- 通知發送 API 測試 (100% 自動化)
- 模板變數替換測試 (90% 自動化)
- 批量通知效能測試 (85% 自動化)
- 回歸測試案例 (80% 自動化)

**不適合自動化的測試**:
- Email 實際接收驗證
- 用戶界面通知顯示測試
- 複雜的排程時間測試

### 7.2 自動化工具和框架
**測試框架**: Jest + Supertest
**Email 測試工具**: MailHog, Ethereal Email
**排程測試工具**: 自定義時間模擬工具
**CI/CD 整合**: GitHub Actions

### 7.3 自動化測試維護
**維護策略**:
- 通知模板變更時更新測試腳本
- 定期檢查 Email 服務配置
- 自動化測試結果集成到 CI/CD 流程

---

## 8. 風險與應對措施

### 8.1 測試風險識別
| 風險項目 | 風險等級 | 影響描述 | 應對措施 |
|---------|---------|---------|---------|
| Email 服務不穩定 | 高 | 影響 Email 通知測試 | 準備備用 Email 服務 |
| 排程測試時間長 | 中 | 影響測試執行效率 | 使用時間模擬工具 |
| 大量通知